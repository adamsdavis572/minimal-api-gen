# Contract: AuthorizedEndpointExtensions.cs

**Status**: NEW - Test artifact initially, MINIMAL generator hook after validation  
**Source**: `petstore-tests/Auth/AuthorizedEndpointExtensions.cs` (test phase)  
**Copied To**: `test-output/src/PetstoreApi/Extensions/AuthorizedEndpointExtensions.cs` (via gen:copy-test-stubs)  
**Purpose**: Extension method that registers ALL endpoints with authorization filter applied to route group

**Generator Integration** (if successful): MINIMAL template for this file ONLY when useAuthentication=true

---

## Purpose

Provide an extension method `AddAuthorizedApiEndpoints()` that:
1. Creates a route group (e.g., `/v2`)
2. Applies `PermissionEndpointFilter` to the route group
3. Delegates to generated endpoint registration methods
4. Exists alongside the generated `AddApiEndpoints()` (no modification to generated code)

**Pattern**: Decorator extension method that wraps generated endpoint registration

---

## Implementation Structure

```csharp
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Routing;
using PetstoreApi.Endpoints;
using PetstoreApi.Filters;

namespace PetstoreApi.Extensions;

/// <summary>
/// Extension methods for registering API endpoints WITH authorization filtering
/// </summary>
public static class AuthorizedEndpointExtensions
{
    /// <summary>
    /// Registers all API endpoints with authorization filter applied.
    /// Delegates to generated endpoint registration methods.
    /// </summary>
    /// <param name="endpoints">The endpoint route builder</param>
    /// <returns>The endpoint route builder for chaining</returns>
    public static IEndpointRouteBuilder AddAuthorizedApiEndpoints(this IEndpointRouteBuilder endpoints)
    {
        // Create route group with authorization filter
        var group = endpoints.MapGroup("/v2")
            .AddEndpointFilter<PermissionEndpointFilter>();
        
        // Delegate to generated endpoint registration methods
        PetEndpoints.MapPetEndpoints(group);
        StoreEndpoints.MapStoreEndpoints(group);
        UserEndpoints.MapUserEndpoints(group);
        
        return endpoints;
    }
}
```

---

## Data Structure

### Input
- `IEndpointRouteBuilder endpoints` - ASP.NET Core endpoint routing builder

### Output
- `IEndpointRouteBuilder` - Same builder instance (for method chaining)

### Dependencies
- `PetEndpoints.MapPetEndpoints()` (generated)
- `StoreEndpoints.MapStoreEndpoints()` (generated)
- `UserEndpoints.MapUserEndpoints()` (generated)
- `PermissionEndpointFilter` (authorization filter)

---

## Comparison with Generated Code

### Generated Extension Method (Contract Package)
```csharp
// File: test-output/Contract/Extensions/EndpointExtensions.cs
// Generated by: endpointExtensions.mustache

using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Routing;
using PetstoreApi.Endpoints;

namespace PetstoreApi.Contracts.Extensions;

public static class EndpointExtensions
{
    /// <summary>
    /// Registers all API endpoints from the Contracts package.
    /// </summary>
    public static IEndpointRouteBuilder AddApiEndpoints(this IEndpointRouteBuilder endpoints)
    {
        var group = endpoints.MapGroup("/v2");  // NO filter applied
        
        PetEndpoints.MapPetEndpoints(group);
        StoreEndpoints.MapStoreEndpoints(group);
        UserEndpoints.MapUserEndpoints(group);
        
        return endpoints;
    }
}
```

### NEW: Authorized Extension Method (Implementation Package)
```csharp
// File: test-output/Implementation/Extensions/AuthorizedEndpointExtensions.cs
// Created manually as test artifact

using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Routing;
using PetstoreApi.Endpoints;
using PetstoreApi.Filters;

namespace PetstoreApi.Extensions;

public static class AuthorizedEndpointExtensions
{
    public static IEndpointRouteBuilder AddAuthorizedApiEndpoints(this IEndpointRouteBuilder endpoints)
    {
        var group = endpoints.MapGroup("/v2")
            .AddEndpointFilter<PermissionEndpointFilter>();  // FILTER APPLIED HERE
        
        PetEndpoints.MapPetEndpoints(group);
        StoreEndpoints.MapStoreEndpoints(group);
        UserEndpoints.MapUserEndpoints(group);
        
        return endpoints;
    }
}
```

**Key Difference**: The ONLY difference is `.AddEndpointFilter<PermissionEndpointFilter>()` on the route group.

---

## Validation Rules

### 1. Extension Method Pattern
```csharp
public static IEndpointRouteBuilder AddAuthorizedApiEndpoints(this IEndpointRouteBuilder endpoints)
{
    // ...
    return endpoints; // MUST return for method chaining
}
```

**Requirements**:
- MUST be `static` method
- MUST extend `IEndpointRouteBuilder`
- MUST return `IEndpointRouteBuilder` for chaining

### 2. Route Group Configuration
```csharp
var group = endpoints.MapGroup("/v2")
    .AddEndpointFilter<PermissionEndpointFilter>();
```

**Requirements**:
- Route prefix ("/v2") MUST match generated code
- Filter MUST be applied to group (not individual endpoints)
- Filter type MUST be registered in DI container

### 3. Endpoint Registration Delegation
```csharp
PetEndpoints.MapPetEndpoints(group);
StoreEndpoints.MapStoreEndpoints(group);
UserEndpoints.MapUserEndpoints(group);
```

**Requirements**:
- MUST call ALL generated `Map{Tag}Endpoints()` methods
- MUST pass the route group (not the endpoints builder)
- Order does NOT matter (no dependencies between tags)

---

## Usage Example

### Program.cs Configuration

**Option 1: Without Authorization** (existing)
```csharp
using PetstoreApi.Contracts.Extensions;

var app = builder.Build();

// Use generated extension method (no authorization)
app.AddApiEndpoints();  // From Contract package

app.Run();
```

**Option 2: With Authorization** (new)
```csharp
using PetstoreApi.Extensions;  // Implementation package

var app = builder.Build();

// Add authentication/authorization middleware
app.UseAuthentication();
app.UseAuthorization();

// Use authorized extension method (with filter)
app.AddAuthorizedApiEndpoints();  // From Implementation package

app.Run();
```

**Key Point**: Developers choose which extension method to call:
- `AddApiEndpoints()` - No authorization (open API)
- `AddAuthorizedApiEndpoints()` - Authorization enforced

---

## Testing Strategy

### Unit Tests (Extension Method)
```csharp
[Fact]
public void AddAuthorizedApiEndpoints_RegistersEndpointsWithFilter()
{
    // Arrange
    var serviceCollection = new ServiceCollection();
    serviceCollection.AddSingleton<PermissionEndpointFilter>();
    var services = serviceCollection.BuildServiceProvider();
    
    var builder = WebApplication.CreateBuilder();
    builder.Services.AddSingleton(services.GetService<PermissionEndpointFilter>());
    var app = builder.Build();
    
    // Act
    app.AddAuthorizedApiEndpoints();
    
    // Assert
    // Verify endpoints are registered (check via endpoint data source)
    var endpoints = app.Services.GetService<EndpointDataSource>();
    endpoints.Endpoints.Should().NotBeEmpty();
}
```

### Integration Tests (End-to-End)
```csharp
[Fact]
public async Task AddAuthorizedApiEndpoints_EnforcesAuthorization()
{
    // Arrange
    var factory = new AuthorizedWebApplicationFactory();  // Includes authorization setup
    var client = factory.CreateClient();
    
    // Act - POST without authorization header
    var response = await client.PostAsJsonAsync("/v2/pet", new Pet { Name = "Fluffy" });
    
    // Assert
    response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);  // 401 if no auth
}
```

---

## Relationship to Generated Code

### Generated Files (UNTOUCHED)
- `Contract/Extensions/EndpointExtensions.cs` → `AddApiEndpoints()` method
- `Contract/Endpoints/PetEndpoints.cs` → `MapPetEndpoints()` method
- `Contract/Endpoints/StoreEndpoints.cs` → `MapStoreEndpoints()` method
- `Contract/Endpoints/UserEndpoints.cs` → `MapUserEndpoints()` method

### New Files (ADDED)
- `Implementation/Extensions/AuthorizedEndpointExtensions.cs` → `AddAuthorizedApiEndpoints()` method
- `Implementation/Filters/PermissionEndpointFilter.cs` → Authorization filter

**Immutability Guarantee**: Contract package files are NEVER modified. Authorization is purely additive.

---

## Alternative Patterns Considered

### 1. Modify Generated Extension Method
```csharp
// ❌ REJECTED - violates immutability constraint
public static IEndpointRouteBuilder AddApiEndpoints(this IEndpointRouteBuilder endpoints, bool useAuthorization = false)
{
    var group = endpoints.MapGroup("/v2");
    if (useAuthorization)
    {
        group.AddEndpointFilter<PermissionEndpointFilter>();
    }
    // ...
}
```
**Reason Rejected**: Modifies generated code in Contract package

### 2. Apply Filter via Middleware
```csharp
// ❌ REJECTED - no access to endpoint metadata, harder to map policies
app.UseMiddleware<AuthorizationMiddleware>();
```
**Reason Rejected**: Middleware executes before endpoint routing, no access to `EndpointNameMetadata`

### 3. Individual Filter Per Endpoint
```csharp
// ❌ REJECTED - requires modifying generated endpoints
group.MapPost("/pet", handler)
    .WithName("AddPet")
    .AddEndpointFilter<PermissionEndpointFilter>();  // Per-endpoint filter
```
**Reason Rejected**: Requires modifying generated endpoint code

---

## Future Enhancements

### 1. Template Generation (Generator Integration)
```mustache
{{#useAuthentication}}
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Routing;
using {{{packageName}}}.Endpoints;
using {{{packageName}}}.Filters;

namespace {{{packageName}}}.Extensions;

public static class AuthorizedEndpointExtensions
{
    public static IEndpointRouteBuilder AddAuthorizedApiEndpoints(this IEndpointRouteBuilder endpoints)
    {
        var group = endpoints.MapGroup("{{{serverBasePath}}}")
            .AddEndpointFilter<PermissionEndpointFilter>();
        
        {{#apiInfo}}
        {{#apis}}
        {{classname}}Endpoints.Map{{classname}}Endpoints(group);
        {{/apis}}
        {{/apiInfo}}
        
        return endpoints;
    }
}
{{/useAuthentication}}
```

### 2. Conditional Compilation
Only generate if `useAuthentication=true` CLI flag is set:
```bash
java -jar generator.jar generate \
  -g aspnetcore-minimalapi \
  -i petstore.yaml \
  -o output/ \
  --additional-properties useAuthentication=true
```

### 3. Multiple Filter Support
```csharp
var group = endpoints.MapGroup("/v2")
    .AddEndpointFilter<LoggingFilter>()           // Log all requests
    .AddEndpointFilter<PermissionEndpointFilter>() // Then authorize
    .AddEndpointFilter<RateLimitFilter>();        // Then rate limit
```

---

**Status**: Complete - Ready for implementation in test artifacts
