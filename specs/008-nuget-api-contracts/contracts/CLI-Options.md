# Contract: Generator CLI Options for NuGet Packaging

**Feature**: 008-nuget-api-contracts  
**Status**: Draft  
**Purpose**: Document all generator CLI options for enabling and configuring NuGet package generation

---

## Overview

Feature 008 adds NuGet packaging capability to the OpenAPI generator, allowing API contracts (Endpoints, DTOs, Validators) to be packaged and distributed independently from implementation code (Handlers, Models). This contract defines the CLI options that control package generation, metadata, and structure.

**Key Benefit**: Independent versioning of API surface layer without coupling to business logic implementations.

---

## New CLI Options (Feature 008)

### useNugetPackaging

- **Type**: `boolean`
- **Default**: `false`
- **Description**: Enables dual-project generation mode. When `true`, generator creates two separate `.csproj` files: one for NuGet package (Contracts) containing Endpoints/DTOs/Validators, and one for Implementation containing Handlers/Models/Program.cs. When `false`, generates a single monolithic project.
- **Related FRs**: FR-001, FR-002, FR-022
- **Related User Stories**: US1 (Package API Contracts), US2 (Inject Services)
- **Validation**: Must be boolean literal (`true` or `false`)
- **Dependencies**: Requires `useMediatr=true` (assumes MediatR architecture from Feature 006)
- **Output Impact**:
  - `true`: Generates `src/{packageName}.Contracts/{packageName}.Contracts.csproj` and `src/{packageName}/{packageName}.csproj`
  - `false`: Generates `src/{packageName}/{packageName}.csproj` only
- **Example**: `useNugetPackaging=true`

---

### packageId

- **Type**: `string`
- **Default**: `{packageName}.Contracts` (derived from `packageName` property)
- **Description**: Specifies the NuGet package identifier used in `.nupkg` filename and package feeds. Must follow NuGet naming conventions (alphanumeric, dots, hyphens, underscores). This is the unique identifier consumers use when installing via `dotnet add package`.
- **Related FRs**: FR-011, FR-016
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**: 
  - Must match regex: `^[A-Za-z0-9_.-]+$`
  - Length: 1-100 characters
  - Cannot start or end with dot
- **Example Usage**:
  - Basic: `packageId=MyCompany.PetStore.Contracts`
  - Versioned API: `packageId=Acme.Inventory.V2.Contracts`
  - Team prefix: `packageId=Platform.PetStore.ApiContracts`
- **MSBuild Property**: Maps to `<PackageId>` in `.csproj`

---

### packageVersion

- **Type**: `string` (SemVer 2.0.0 format)
- **Default**: `1.0.0`
- **Description**: Specifies the semantic version for the NuGet package. Must follow SemVer 2.0.0 specification: `MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]`. This version is embedded in `.nupkg` filename and used for dependency resolution.
- **Related FRs**: FR-012, FR-016
- **Related User Stories**: US3 (Version API Contracts), US4 (Configure Package Metadata)
- **Validation**:
  - Must match SemVer regex: `^\d+\.\d+\.\d+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$`
  - Examples of valid versions:
    - Stable: `1.0.0`, `2.3.5`
    - Prerelease: `1.0.0-alpha`, `2.1.0-beta.1`, `3.0.0-rc.2`
    - Build metadata: `1.0.0+20250127`, `2.0.0-beta+build.123`
- **Versioning Guidelines** (from spec assumptions):
  - **Patch** (1.0.X): Bug fixes, no API changes
  - **Minor** (1.X.0): Backward-compatible changes (new optional properties, new endpoints)
  - **Major** (X.0.0): Breaking changes (renamed properties, removed endpoints, type changes)
- **Example Usage**:
  - Initial release: `packageVersion=1.0.0`
  - Add optional field: `packageVersion=1.1.0` (backward-compatible)
  - Breaking change: `packageVersion=2.0.0` (forces Handler updates)
- **MSBuild Property**: Maps to `<Version>` in `.csproj`

---

### packageAuthors

- **Type**: `string`
- **Default**: `Generated by OpenAPI Generator`
- **Description**: Specifies the author(s) of the NuGet package, displayed on NuGet feed and in package metadata. Can be a single name or comma-separated list. Visible to package consumers for attribution and support contact.
- **Related FRs**: FR-013, FR-016
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**:
  - Length: 1-250 characters
  - No specific character restrictions (free-form text)
  - Commas separate multiple authors
- **Example Usage**:
  - Single author: `packageAuthors=Platform Team`
  - Multiple authors: `packageAuthors=Alice Smith,Bob Jones,Platform Team`
  - Company: `packageAuthors=Acme Corporation`
- **MSBuild Properties**: Maps to both `<Authors>` and `<Company>` (set to same value)

---

### packageDescription

- **Type**: `string`
- **Default**: `API contracts (DTOs, Endpoints, Validators) for {packageName} generated from OpenAPI specification` (auto-generated from `packageName`)
- **Description**: Provides a human-readable description of the package, displayed on NuGet feed search results and package details page. Should explain what the package contains and its purpose. Critical for discoverability on nuget.org.
- **Related FRs**: FR-014, FR-016
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**:
  - Length: 1-4000 characters (NuGet limit)
  - Supports basic Markdown in some NuGet clients
- **Example Usage**:
  - Basic: `packageDescription=API contracts for Petstore application`
  - Detailed: `packageDescription=Contains DTOs, endpoints, and validators for the Petstore REST API v2. Use this package to integrate with the Petstore backend service.`
- **MSBuild Property**: Maps to `<Description>` in `.csproj`

---

### includeSymbols

- **Type**: `boolean`
- **Default**: `false`
- **Description**: Enables symbol package generation (`.snupkg`) containing PDB files and source code for debugging. When `true`, `dotnet pack` produces both `.nupkg` (binaries) and `.snupkg` (debugging symbols). Allows developers to step into packaged code during debugging sessions. Recommended for internal/private packages, optional for public packages.
- **Related FRs**: FR-015, FR-016
- **Related User Stories**: US5 (Symbol Package for Debugging)
- **Validation**: Must be boolean literal (`true` or `false`)
- **Output Impact**:
  - `true`: `dotnet pack` produces both `{packageId}.{version}.nupkg` and `{packageId}.{version}.snupkg`
  - `false`: `dotnet pack` produces only `{packageId}.{version}.nupkg`
- **MSBuild Properties**: 
  - Maps to `<IncludeSymbols>true</IncludeSymbols>`
  - Sets `<SymbolPackageFormat>snupkg</SymbolPackageFormat>` (modern format)
- **Performance**: Adds ~10-30% to package size, minimal impact on pack time
- **Example**: `includeSymbols=true`

---

## Extended Metadata Options (Optional)

The following options enhance NuGet package discoverability and compliance but are **optional** - tags will be excluded from .csproj if not provided. This allows runtime configuration via MSBuild properties.

### packageLicenseExpression

- **Type**: `string`
- **Default**: *(empty - tag excluded from .csproj if not provided)*
- **Description**: SPDX license identifier for the package (e.g., `Apache-2.0`, `MIT`, `GPL-3.0`). Required for publishing to nuget.org. When not provided via CLI, the tag is excluded from .csproj, allowing runtime override via MSBuild property.
- **Related FRs**: FR-016 (extended metadata)
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**: Should match SPDX license list (not enforced by generator)
- **MSBuild Property**: Maps to `<PackageLicenseExpression>` (conditional rendering)
- **Runtime Override**: 
  ```bash
  # Via CLI option (baked into .csproj)
  packageLicenseExpression=MIT
  
  # Via MSBuild property at pack time (if tag exists in .csproj)
  dotnet pack -p:PackageLicenseExpression=MIT
  
  # Via environment variable (if .csproj uses $(NUGET_LICENSE))
  NUGET_LICENSE=MIT dotnet pack
  ```
- **Example**: `packageLicenseExpression=Apache-2.0`
- **SPDX Examples**: `MIT`, `Apache-2.0`, `GPL-3.0-or-later`, `BSD-3-Clause`, `ISC`, `MPL-2.0`

---

### packageRepositoryUrl

- **Type**: `string`
- **Default**: *(empty - tag excluded from .csproj if not provided)*
- **Description**: Git repository URL for the source code (e.g., `https://github.com/company/repo`). Enhances package trust and discoverability on NuGet feeds. When not provided, tag is excluded from .csproj.
- **Related FRs**: FR-016 (extended metadata)
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**: Should be valid URL (not enforced by generator)
- **MSBuild Properties**: 
  - Maps to `<RepositoryUrl>` (conditional rendering)
  - Sets `<RepositoryType>git</RepositoryType>` automatically
- **Runtime Override**:
  ```bash
  # Via CLI option
  packageRepositoryUrl=https://github.com/mycompany/petstore
  
  # Via MSBuild property at pack time
  dotnet pack -p:RepositoryUrl=https://github.com/mycompany/petstore
  
  # Via environment variable (if .csproj template uses $(REPO_URL))
  REPO_URL=https://github.com/mycompany/petstore dotnet pack
  ```
- **Example**: `packageRepositoryUrl=https://github.com/acme/petstore-api`

---

### packageProjectUrl

- **Type**: `string`
- **Default**: *(empty - tag excluded from .csproj if not provided)*
- **Description**: Project homepage or documentation URL. Points consumers to docs, support channels, or project landing page. When not provided, tag is excluded from .csproj.
- **Related FRs**: FR-016 (extended metadata)
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**: Should be valid URL (not enforced by generator)
- **MSBuild Property**: Maps to `<PackageProjectUrl>` (conditional rendering)
- **Runtime Override**:
  ```bash
  # Via CLI option
  packageProjectUrl=https://petstore.docs.acme.com
  
  # Via MSBuild property
  dotnet pack -p:PackageProjectUrl=https://docs.acme.com/petstore
  ```
- **Example**: `packageProjectUrl=https://petstore-api.docs.acme.com`

---

### packageTags

- **Type**: `string` (semicolon-separated)
- **Default**: *(empty - tag excluded from .csproj if not provided)*
- **Description**: Semicolon-separated keywords for package discoverability on NuGet feeds. Improves searchability and categorization. When not provided, tag is excluded from .csproj.
- **Related FRs**: FR-016 (extended metadata)
- **Related User Stories**: US4 (Configure Package Metadata)
- **Validation**: Semicolon separator (spaces around tags trimmed by NuGet)
- **MSBuild Property**: Maps to `<PackageTags>` (conditional rendering)
- **Runtime Override**:
  ```bash
  # Via CLI option
  packageTags=openapi;rest-api;contracts;minimal-api
  
  # Via MSBuild property
  dotnet pack -p:PackageTags="openapi;rest;petstore"
  
  # Via environment variable
  PACKAGE_TAGS="openapi;rest;api" dotnet pack
  ```
- **Example**: `packageTags=openapi;rest-api;contracts;microservices;petstore`
- **Best Practices**: 3-7 tags, lowercase, specific to generic order

---

## Template Behavior for Extended Metadata

The `.csproj` template uses **conditional Mustache sections** to exclude tags when values not provided:

```xml
<!-- Only rendered if packageLicenseExpression provided -->
{{#packageLicenseExpression}}
<PackageLicenseExpression>{{packageLicenseExpression}}</PackageLicenseExpression>
{{/packageLicenseExpression}}

<!-- Only rendered if packageRepositoryUrl provided -->
{{#packageRepositoryUrl}}
<RepositoryUrl>{{packageRepositoryUrl}}</RepositoryUrl>
<RepositoryType>git</RepositoryType>
{{/packageRepositoryUrl}}

<!-- Only rendered if packageProjectUrl provided -->
{{#packageProjectUrl}}
<PackageProjectUrl>{{packageProjectUrl}}</PackageProjectUrl>
{{/packageProjectUrl}}

<!-- Only rendered if packageTags provided -->
{{#packageTags}}
<PackageTags>{{packageTags}}</PackageTags>
{{/packageTags}}
```

**Benefits**:
- Clean .csproj without empty/placeholder values
- Allows MSBuild property override at pack time
- Supports environment variable substitution if needed
- No warnings from `dotnet pack` about missing optional metadata

---

## Usage Examples

### Example 1: Minimal NuGet packaging (defaults)
```bash
cd /Users/adam/scratch/git/minimal-api-gen
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true"
```

**Generated output**:
- Package: `PetstoreApi.Contracts` version `1.0.0`
- Author: `Generated by OpenAPI Generator`
- Description: Auto-generated from spec
- No symbols package

---

### Example 2: Production package with full metadata
```bash
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true,packageId=Acme.Petstore.Contracts,packageVersion=2.1.0,packageAuthors=Platform Team,packageDescription=API contracts for Acme Petstore REST API,includeSymbols=true"
```

**Generated output**:
- Package: `Acme.Petstore.Contracts` version `2.1.0`
- Author: `Platform Team`
- Description: Custom description
- Symbol package included for debugging

---

### Example 3: Prerelease package for testing
```bash
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true,packageId=MyCompany.Petstore.Contracts,packageVersion=3.0.0-beta.1,packageAuthors=API Team"
```

**Generated output**:
- Package: `MyCompany.Petstore.Contracts` version `3.0.0-beta.1` (prerelease)
- Suitable for testing in non-production environments
- NuGet clients will not install prerelease versions by default

---

### Example 4: Package with validators enabled
```bash
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true,useValidators=true,packageId=PetstoreApi.Contracts,packageVersion=1.2.0"
```

**Generated output**:
- Package includes Validators/ directory (FluentValidation rules)
- Contracts.csproj includes `PackageReference` to FluentValidation
- Consumers must call `AddApiValidators()` in Program.cs

---

### Example 5: Building and packing the generated package
```bash
# Generate code with NuGet packaging
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true,packageVersion=1.0.0"

# Build the Contracts project
devbox run -- dotnet build test-output/src/PetstoreApi.Contracts/

# Pack into .nupkg
devbox run -- dotnet pack test-output/src/PetstoreApi.Contracts/ --configuration Release --output ./nupkgs/

# Verify package contents
devbox run -- unzip -l nupkgs/PetstoreApi.Contracts.1.0.0.nupkg
```

**Expected package contents**:
```
lib/net8.0/PetstoreApi.Contracts.dll
PetstoreApi.Contracts.nuspec
[Content_Types].xml
_rels/.rels
```

---

## Compatibility Matrix

### Options That Work Together

| `useNugetPackaging` | `useMediatr` | `useValidators` | Result |
|---------------------|--------------|----------------|--------|
| `false` | any | any | Single project (monolithic), no NuGet packaging |
| `true` | `true` | `false` | Contracts package without validators, MediatR handlers in Implementation |
| `true` | `true` | `true` | Contracts package WITH validators, MediatR handlers in Implementation |
| `true` | `false` | any | ⚠️ **NOT SUPPORTED** (spec assumption: requires MediatR architecture) |

---

### Option Dependencies

**useNugetPackaging dependencies**:
- **REQUIRES**: `useMediatr=true` (Feature 006 MediatR architecture is prerequisite)
- **COMPATIBLE**: `useValidators=true/false` (validators conditionally included in Contracts package)
- **COMPATIBLE**: All existing Feature 007 options (validation architecture)

**Validation with other options**:
- `useValidators=true`: Validators packaged in Contracts.dll, registered via `AddApiValidators()`
- `useValidators=false`: No validators in package, no AddApiValidators() method generated

---

### Conflicts and Constraints

**Known limitations**:
1. **Cannot use** `useNugetPackaging=true` without `useMediatr=true` (requires Commands/Queries architecture)
2. **Generator does NOT validate** if `packageVersion` follows SemVer correctly (developer responsibility)
3. **Generator does NOT auto-detect** breaking changes in OpenAPI spec (developer must manually increment major version)

**Build requirements**:
- .NET SDK 8.0+ (for `dotnet pack` support)
- NuGet CLI tools (for publishing to feeds)

**Runtime requirements** (consuming applications):
- .NET 8.0+ (Contracts package targets `net8.0`)
- MediatR 12.2.0+ (dependency of Contracts package)
- FluentValidation 11.9.0+ (if `useValidators=true`)

---

## Command Reference

### Full Property List (all features combined)
```bash
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true,packageId=MyCompany.Petstore.Contracts,packageVersion=1.0.0,packageAuthors=Platform Team,packageDescription=Petstore API contracts,includeSymbols=true,useMediatr=true,useValidators=true"
```

### Minimal Required Properties
```bash
devbox run task generate-petstore-minimal-api ADDITIONAL_PROPS="packageName=PetstoreApi,useNugetPackaging=true"
```

### Default Values Applied
When properties are omitted, these defaults are used:
- `useNugetPackaging`: `false` (single project mode)
- `packageId`: `{packageName}.Contracts` (e.g., `PetstoreApi.Contracts`)
- `packageVersion`: `1.0.0`
- `packageAuthors`: `Generated by OpenAPI Generator`
- `packageDescription`: `API contracts (DTOs, Endpoints, Validators) for {packageName} generated from OpenAPI specification`
- `includeSymbols`: `false`

---

## Implementation Notes

### Property Mapping (Java → Mustache)
```java
// In MinimalApiServerCodegen.java
if (additionalProperties.containsKey("useNugetPackaging")) {
    boolean useNugetPackaging = convertPropertyToBooleanAndWriteBack("useNugetPackaging");
    
    if (useNugetPackaging) {
        // Set defaults for package metadata
        if (!additionalProperties.containsKey("packageId")) {
            additionalProperties.put("packageId", packageName + ".Contracts");
        }
        if (!additionalProperties.containsKey("packageVersion")) {
            additionalProperties.put("packageVersion", "1.0.0");
        }
        if (!additionalProperties.containsKey("packageAuthors")) {
            additionalProperties.put("packageAuthors", "Generated by OpenAPI Generator");
        }
        if (!additionalProperties.containsKey("packageDescription")) {
            additionalProperties.put("packageDescription", 
                "API contracts (DTOs, Endpoints, Validators) for " + packageName + 
                " generated from OpenAPI specification");
        }
        if (!additionalProperties.containsKey("includeSymbols")) {
            additionalProperties.put("includeSymbols", false);
        }
    }
}
```

### Template Usage (Mustache)
```xml
<!-- Contracts.csproj.mustache -->
{{#useNugetPackaging}}
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <PackageId>{{packageId}}</PackageId>
    <Version>{{packageVersion}}</Version>
    <Authors>{{packageAuthors}}</Authors>
    <Description>{{packageDescription}}</Description>
    {{#includeSymbols}}
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    {{/includeSymbols}}
  </PropertyGroup>
</Project>
{{/useNugetPackaging}}
```

---

## Testing Checklist

**Generator tests** (verify CLI parsing):
- [ ] `useNugetPackaging=true` generates two .csproj files
- [ ] `useNugetPackaging=false` generates one .csproj file
- [ ] `packageId` is correctly embedded in Contracts.csproj
- [ ] `packageVersion` follows SemVer format in .csproj
- [ ] `packageAuthors` appears in both `<Authors>` and `<Company>`
- [ ] `packageDescription` appears in `<Description>`
- [ ] `includeSymbols=true` adds symbol properties to .csproj

**Build tests** (verify output):
- [ ] `dotnet build` succeeds on Contracts project
- [ ] `dotnet pack` produces valid .nupkg file
- [ ] `dotnet pack` with `includeSymbols=true` produces .snupkg file
- [ ] Package contains only Endpoints/, DTOs/, Validators/ (no Handlers/, Models/)

**Integration tests** (verify runtime behavior):
- [ ] Host application can restore NuGet package
- [ ] Host application compiles with package reference
- [ ] Endpoints execute correctly using packaged code
- [ ] Validators work when packaged (if `useValidators=true`)

---

## Related Documentation

- [spec.md](../spec.md) - Feature specification with user stories
- [research.md](../research.md) - Technical research and design decisions
- [data-model.md](../data-model.md) - Entity definitions
- [CsprojStructure.md](./CsprojStructure.md) - Generated .csproj file structure
- [ExtensionMethods.md](./ExtensionMethods.md) - DI registration API
