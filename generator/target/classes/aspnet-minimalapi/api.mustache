{{#operations}}
#pragma warning disable ASP0020 // Complex types as query parameters
using FluentValidation;
using Microsoft.AspNetCore.Mvc;
using {{{packageName}}}.Models;
{{#useMediatr}}
using MediatR;
using {{{packageName}}}.Commands;
using {{{packageName}}}.Queries;
{{/useMediatr}}

namespace {{{packageName}}}.Endpoints;

/// <summary>
/// Minimal API endpoints for {{{classname}}} operations
/// </summary>
public static class {{{classname}}}Endpoints
{
    /// <summary>
    /// Maps all {{{classname}}} endpoints to the route group
    /// </summary>
    public static RouteGroupBuilder Map{{{classname}}}Endpoints(this RouteGroupBuilder group)
    {
        {{#operation}}
        {{^hasFormParams}}
        // {{{httpMethod}}} {{{path}}}{{#summary}} - {{{summary}}}{{/summary}}
        group.Map{{{httpMethod}}}("{{{path}}}", async ({{#useMediatr}}IMediator mediator{{#vendorExtensions.hasComplexQueryParam}}, HttpContext httpContext{{/vendorExtensions.hasComplexQueryParam}}{{/useMediatr}}{{^useMediatr}}HttpContext httpContext{{/useMediatr}}{{#allParams}}{{^isFormParam}}{{^vendorExtensions.x-is-complex-query-param}}, {{#isHeaderParam}}[FromHeader] {{/isHeaderParam}}{{#isQueryParam}}{{^isModel}}[FromQuery] {{/isModel}}{{/isQueryParam}}{{#isBodyParam}}[FromBody] {{/isBodyParam}}{{{dataType}}} {{{paramName}}}{{#hasValidation}}{{#isBodyParam}}, IValidator<{{{dataType}}}> validator{{/isBodyParam}}{{/hasValidation}}{{/vendorExtensions.x-is-complex-query-param}}{{/isFormParam}}{{/allParams}}) =>
        {
            {{^bodyParam}}
            {{#allParams}}
            {{#isQueryParam}}
            {{#isModel}}
            // Deserialize complex object from query parameter
            var {{{paramName}}}Json = httpContext.Request.Query["{{{baseName}}}"].FirstOrDefault();
            if (string.IsNullOrEmpty({{{paramName}}}Json))
            {
                return Results.BadRequest("Missing required query parameter: {{{baseName}}}");
            }
            {{{dataType}}}? {{{paramName}}} = null;
            try
            {
                {{{paramName}}} = System.Text.Json.JsonSerializer.Deserialize<{{{dataType}}}>({{{paramName}}}Json);
            }
            catch (System.Text.Json.JsonException)
            {
                return Results.BadRequest("Invalid JSON in query parameter: {{{baseName}}}");
            }
            if ({{{paramName}}} == null)
            {
                return Results.BadRequest("Failed to deserialize query parameter: {{{baseName}}}");
            }
            
            {{/isModel}}
            {{/isQueryParam}}
            {{/allParams}}
            {{/bodyParam}}
            {{#bodyParam}}
            {{#hasValidation}}
            // Validate request
            var validationResult = await validator.ValidateAsync({{{paramName}}});
            if (!validationResult.IsValid)
            {
                return Results.ValidationProblem(validationResult.ToDictionary());
            }
            
            {{/hasValidation}}
            {{/bodyParam}}
                        {{#useMediatr}}
            // MediatR delegation
            {{#vendorExtensions.isQuery}}
            var query = new {{{vendorExtensions.queryClassName}}}
            {
                {{#allParams}}
                {{^isFormParam}}
                {{{paramName}}} = {{{paramName}}}{{^-last}},{{/-last}}
            {{/isFormParam}}
            {{/allParams}}
            };
            var result = await mediator.Send(query);
            {{#returnType}}
            {{#isListContainer}}
            return Results.Ok(result);
            {{/isListContainer}}
            {{^isListContainer}}
            if (result == null) return Results.NotFound();
            return Results.Ok(result);
            {{/isListContainer}}
            {{/returnType}}
            {{^returnType}}
            return Results.Ok();
            {{/returnType}}
            {{/vendorExtensions.isQuery}}
            {{#vendorExtensions.isCommand}}
            var command = new {{{vendorExtensions.commandClassName}}}
            {
                {{#allParams}}
                {{^isFormParam}}
                {{{paramName}}} = {{{paramName}}}{{^-last}},{{/-last}}
                {{/isFormParam}}
                {{/allParams}}
            };
            var result = await mediator.Send(command);
            {{#returnType}}
            {{#isListContainer}}
            return Results.Ok(result);
            {{/isListContainer}}
            {{^isListContainer}}
            {{#vendorExtensions.x-is-delete-with-bool}}
            // DELETE with bool return - check if resource was found
            return result ? Results.NoContent() : Results.NotFound();
            {{/vendorExtensions.x-is-delete-with-bool}}
            {{^vendorExtensions.x-is-delete-with-bool}}
            if (result == null) return Results.NotFound();
            {{#vendorExtensions.x-is-post-operation}}
            return Results.Created($"{{basePathWithoutHost}}{{path}}", result);
            {{/vendorExtensions.x-is-post-operation}}
            {{^vendorExtensions.x-is-post-operation}}
            return Results.Ok(result);
            {{/vendorExtensions.x-is-post-operation}}
            {{/vendorExtensions.x-is-delete-with-bool}}
            {{/isListContainer}}
            {{/returnType}}
            {{^returnType}}
            return Results.NoContent();
            {{/returnType}}
            {{/vendorExtensions.isCommand}}
            {{/useMediatr}}
            {{^useMediatr}}
            // TODO: Implement {{{nickname}}} logic
            {{#returnType}}
            {{#returnSimpleType}}
            {{{returnType}}} result = default;
            {{/returnSimpleType}}
            {{^returnSimpleType}}
            var result = new {{{returnType}}}();
            {{/returnSimpleType}}
            return Results.Ok(result);
            {{/returnType}}
            {{^returnType}}
            return Results.NoContent();
            {{/returnType}}
            {{/useMediatr}}
        })
        .WithName("{{{vendorExtensions.operationIdPascalCase}}}")
        {{#summary}}
        .WithSummary("{{{summary}}}")
        {{/summary}}
        {{#returnType}}
        .Produces<{{{returnType}}}>(200)
        {{/returnType}}
        .ProducesProblem(400);

        {{/hasFormParams}}
        {{/operation}}
        return group;
    }
}
{{/operations}}