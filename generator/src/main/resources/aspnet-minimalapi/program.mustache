{{#useValidators}}using FluentValidation;
{{/useValidators}}using {{packageName}}.Configurators;
using {{packageName}}.Extensions;
{{#useNugetPackaging}}
using {{packageName}}.Contracts.Extensions;
{{/useNugetPackaging}}
{{#useValidators}}
{{#useMediatr}}
using Microsoft.AspNetCore.Mvc;
{{/useMediatr}}
{{/useValidators}}

var builder = WebApplication.CreateBuilder(args);

// Add services to the container
// Configure JSON serialization with enum member support
builder.Services.ConfigureHttpJsonOptions(options =>
{
    options.SerializerOptions.Converters.Add(new {{packageName}}.Converters.EnumMemberJsonConverterFactory());
    options.SerializerOptions.PropertyNameCaseInsensitive = true;
});
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("{{{version}}}{{^version}}v1{{/version}}", new Microsoft.OpenApi.Models.OpenApiInfo
    {
        Title = "{{{appName}}}{{^appName}}{{packageName}}{{/appName}}",
        Description = "{{{packageDescription}}}",
        Version = "{{{version}}}{{^version}}v1{{/version}}"
    });
});
{{#useProblemDetails}}
builder.Services.AddProblemDetails();
{{/useProblemDetails}}
{{#useValidators}}
{{#useNugetPackaging}}
// Register validators from Contracts package
builder.Services.AddApiValidators();
{{/useNugetPackaging}}
{{^useNugetPackaging}}
builder.Services.AddValidatorsFromAssemblyContaining<Program>();
{{/useNugetPackaging}}
{{#useMediatr}}
builder.Services.AddTransient(typeof(MediatR.IPipelineBehavior<,>), typeof({{packageName}}.Behaviors.ValidationBehavior<,>));
{{/useMediatr}}
{{/useValidators}}
{{#useMediatr}}
{{#useNugetPackaging}}
// Register handlers from Implementation assembly
builder.Services.AddApiHandlers();
{{/useNugetPackaging}}
{{^useNugetPackaging}}
builder.Services.AddMediatR(cfg => cfg.RegisterServicesFromAssembly(typeof(Program).Assembly));
{{/useNugetPackaging}}
{{/useMediatr}}
{{#useResponseCaching}}
builder.Services.AddResponseCaching();
{{/useResponseCaching}}

// --- Scan and register application-specific services ---
var serviceConfigurators = typeof(Program).Assembly.GetTypes()
    .Where(t => typeof(IServiceConfigurator).IsAssignableFrom(t) && !t.IsInterface && !t.IsAbstract)
    .Select(Activator.CreateInstance)
    .Cast<IServiceConfigurator>();
foreach (var configurator in serviceConfigurators)
    configurator.ConfigureServices(builder.Services, builder.Configuration, builder.Environment);

var app = builder.Build();

// Configure the HTTP request pipeline
{{#useGlobalExceptionHandler}}
app.UseApiExceptionHandler(app.Environment);
{{/useGlobalExceptionHandler}}

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/{{{version}}}{{^version}}v1{{/version}}/swagger.json", "{{{appName}}}{{^appName}}{{packageName}}{{/appName}} {{{version}}}{{^version}}v1{{/version}}");
    });
}

app.UseHttpsRedirection();
app.UseRouting();
{{#useResponseCaching}}
app.UseResponseCaching();
{{/useResponseCaching}}

// --- Scan and configure application-specific middleware (ordered) ---
var appConfigurators = typeof(Program).Assembly.GetTypes()
    .Where(t => typeof(IApplicationConfigurator).IsAssignableFrom(t) && !t.IsInterface && !t.IsAbstract)
    .Select(Activator.CreateInstance)
    .Cast<IApplicationConfigurator>()
    .OrderBy(c => c.Order);
foreach (var configurator in appConfigurators)
    configurator.Configure(app, app.Environment);

// Register all API endpoints (IEndpointFilter instances from DI are applied automatically)
{{#useNugetPackaging}}
app.AddApiEndpoints();
{{/useNugetPackaging}}
{{^useNugetPackaging}}
app.MapAllEndpoints();
{{/useNugetPackaging}}

// Health check endpoint
app.MapGet("/health", () => Results.Ok(new { status = "healthy" }))
    .WithName("HealthCheck")
    .WithTags("Health")
    .Produces(200);

app.Run();

// Make Program accessible for testing
public partial class Program { }